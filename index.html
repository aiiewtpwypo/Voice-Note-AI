<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËàíÂøÉÊóÖÁ®ãË¶èÂäÉ</title>
    
    <!-- ÂºïÂÖ• Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ÂºïÂÖ• Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- ÂºïÂÖ• Leaflet (Âú∞Âúñ) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <!-- ÂºïÂÖ• html2canvas (Êà™ÂúñÂäüËÉΩ) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- ÂÆöÁæ©Ê®°ÁµÑË∑ØÂæë -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #D7CCC8; border-radius: 20px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #A1887F; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .bg-dots-pattern { background-image: radial-gradient(#5D4037 1px, transparent 1px); background-size: 24px 24px; }
        .leaflet-popup-content-wrapper { border-radius: 8px; padding: 0; }
        .leaflet-popup-content { font-family: sans-serif; color: #5D4037; margin: 10px 14px; line-height: 1.4; }
        .leaflet-container { background: #fcfbf9; }
        .custom-marker-icon { transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .custom-marker-icon:hover { transform: scale(1.2); z-index: 1000 !important; }
        .anim-info-panel { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
    </style>
</head>
<body class="bg-[#FDFBF7] text-[#5D4037] font-sans selection:bg-[#CFB997] selection:text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            MapPin, Utensils, Camera, Train, Bed, Plus, Trash2, Edit3, Save, 
            Calendar, Coffee, X, Share2, ExternalLink, ShoppingBag, Music, 
            Sun, Moon, Star, Flag, Plane, Ticket, Gift, Heart, Smile, 
            Umbrella, Anchor, Bike, Zap, BookOpen, Footprints, Car, Bus, 
            Timer, Banknote, Settings, Clock, Navigation, PlayCircle, ArrowRight, Sparkles,
            Coins, Map as MapIcon, CheckCircle2, AlertCircle, Download
        } from 'lucide-react';

        // --- Helper: Âú∞ÂùÄËΩâÂ∫ßÊ®ô (Geocoding) ---
        const fetchCoordinates = async (locationName) => {
            if (!locationName) return null;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationName)}&limit=1`);
                const data = await response.json();
                if (data && data.length > 0) {
                    return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                }
            } catch (error) {
                console.error("Geocoding failed:", error);
            }
            return null;
        };

        // --- Component: Time Picker ---
        const CustomTimePicker = ({ value, onChange, mode = 'default', showIcon = true, onComplete, placement = 'bottom' }) => {
            const [isOpen, setIsOpen] = useState(false);
            const containerRef = useRef(null);
            const [internalTime, setInternalTime] = useState(value || '12:00');

            useEffect(() => { if (value) setInternalTime(value); }, [value]);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (containerRef.current && !containerRef.current.contains(event.target)) setIsOpen(false);
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const [hour, minute] = internalTime.split(':');

            const handleHourChange = (h) => {
                const newTime = `${h}:${minute}`;
                setInternalTime(newTime); 
                if (!onComplete) onChange && onChange(newTime);
            };

            const handleMinuteChange = (m) => {
                const newTime = `${hour}:${m}`;
                setInternalTime(newTime); 
                if (onComplete) onComplete(newTime);
                else onChange && onChange(newTime);
                setIsOpen(false);
            };

            const renderHours = () => {
                const hours = Array.from({ length: 24 }, (_, i) => i.toString().padStart(2, '0'));
                return (
                    <div className="flex-1 border-r border-[#EFEBE0] overflow-y-auto max-h-60 custom-scrollbar p-2">
                        <div className="text-[10px] text-[#A1887F] mb-2 font-bold text-center sticky top-0 bg-white pb-1">ÊôÇ</div>
                        <div className="grid grid-cols-4 gap-1">
                        {hours.map((h) => (
                            <button key={h} onClick={() => handleHourChange(h)} className={`p-2 rounded text-sm font-medium transition-all duration-200 ${hour === h ? 'bg-[#CFB997] text-white shadow-md scale-105' : 'text-[#5D4037] hover:bg-[#F5F0E6]'}`}>{h}</button>
                        ))}
                        </div>
                    </div>
                );
            };

            const renderMinutes = () => {
                const minutes = [];
                for (let i = 0; i < 60; i += 5) { minutes.push(i.toString().padStart(2, '0')); }
                return (
                    <div className="w-20 overflow-y-auto max-h-60 custom-scrollbar bg-[#FAFAFA] p-2">
                        <div className="text-[10px] text-[#A1887F] mb-2 font-bold text-center sticky top-0 bg-[#FAFAFA] pb-1">ÂàÜ</div>
                        <div className="grid grid-cols-1 gap-1">
                        {minutes.map((m) => (
                            <button key={m} onClick={() => handleMinuteChange(m)} className={`py-2 rounded text-sm font-medium transition-colors ${minute === m ? 'bg-[#D7CCC8] text-[#5D4037] font-bold shadow-inner' : 'text-[#5D4037] hover:bg-[#EFEBE0]'}`}>{m}</button>
                        ))}
                        </div>
                    </div>
                );
            };

            let buttonClass = mode === 'minimal' 
                ? `mt-2 text-sm font-bold text-[#8D6E63] font-mono bg-[#FDFBF7] px-2 py-0.5 rounded-md border border-[#EFEBE0] shadow-sm hover:bg-[#EFEBE0] hover:border-[#D7CCC8] transition-all active:scale-95 flex items-center gap-1`
                : `flex items-center gap-2 w-full border rounded-xl px-4 py-3 bg-[#FAFAFA] text-[#5D4037] font-mono text-lg outline-none transition-all duration-300 hover:shadow-sm ${isOpen ? 'ring-2 ring-[#CFB997] border-[#CFB997]' : 'border-[#E0E0E0] hover:border-[#D7CCC8]'}`;

            const placementClass = placement === 'top' ? 'bottom-full mb-2 origin-bottom-left' : 'top-full mt-2 origin-top-left';

            return (
                <div className="relative inline-block" ref={containerRef}>
                    <button type="button" onClick={() => setIsOpen(!isOpen)} className={buttonClass}>
                        {showIcon && <Clock size={mode === 'minimal' ? 14 : 18} className="text-[#CFB997]" />}
                        <span>{internalTime}</span>
                    </button>
                    {isOpen && (
                        <div className={`absolute ${placementClass} left-0 bg-white border border-[#EFEBE0] rounded-xl shadow-xl z-50 flex w-72 overflow-hidden animate-in fade-in zoom-in duration-200`}>
                            {renderHours()} {renderMinutes()}
                        </div>
                    )}
                </div>
            );
        };

        // --- Component: Map Route Animation ---
        const RouteAnimationModal = ({ day, onClose, transportOptions }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markerRef = useRef(null);
            const polylineRef = useRef(null);
            const [isPlaying, setIsPlaying] = useState(false);
            const [isCalculating, setIsCalculating] = useState(true);
            const [currentSegment, setCurrentSegment] = useState(null);

            const activities = day.activities.filter(a => a.location && a.coords);

            const getTransportLabel = (type) => transportOptions.find(t => t.id === type)?.label || 'ÁßªÂãï';
            const getTransportEmoji = (type) => {
                switch(type) {
                    case 'walk': return 'üö∂'; case 'bike': return 'üö≤'; case 'train': return 'üöÜ';
                    case 'mrt': return 'üöá'; case 'bus': return 'üöå'; case 'flight': return '‚úàÔ∏è';
                    case 'ship': return 'üö¢'; case 'taxi': return 'üöï'; case 'car': return 'üöó';
                    default: return 'üöó';
                }
            };

            const fetchSmartRoute = async (coords) => {
                const coordinatesString = coords.map(c => `${c[1]},${c[0]}`).join(';');
                try {
                    const response = await fetch(`https://router.project-osrm.org/route/v1/driving/${coordinatesString}?overview=full&geometries=geojson`);
                    const data = await response.json();
                    if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                        return data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                    }
                } catch (error) { console.error("AI Route failed", error); }
                return coords;
            };

            useEffect(() => {
                if (!mapRef.current || activities.length === 0) return;
                const initMap = async () => {
                    if (!mapInstanceRef.current) {
                        const map = L.map(mapRef.current, { zoomControl: false, attributionControl: false }).setView(activities[0].coords, 13);
                        L.control.zoom({ position: 'bottomright' }).addTo(map);
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap & CARTO', subdomains: 'abcd', maxZoom: 19 }).addTo(map);
                        mapInstanceRef.current = map;
                        setTimeout(() => map.invalidateSize(), 300);
                    }
                    const map = mapInstanceRef.current;
                    map.eachLayer((layer) => { if (layer instanceof L.Marker || layer instanceof L.Polyline) map.removeLayer(layer); });

                    activities.forEach((act, idx) => {
                        const isStart = idx === 0;
                        const isEnd = idx === activities.length - 1;
                        let bgColor = isStart ? '#5D4037' : (isEnd ? '#8D6E63' : '#CFB997');
                        const icon = L.divIcon({
                            className: 'custom-marker-icon',
                            html: `<div style="background-color: ${bgColor}; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; border: 3px solid #fff; box-shadow: 0 3px 8px rgba(0,0,0,0.2);">${idx + 1}</div>`,
                            iconSize: [28, 28], iconAnchor: [14, 14]
                        });
                        L.marker(act.coords, { icon }).bindPopup(`<div class="text-sm"><span class="text-xs text-gray-400 font-mono">${act.time}</span><br/><strong class="text-base text-[#5D4037]">${act.location}</strong></div>`, { offset: [0, -10] }).addTo(map);
                    });

                    setIsCalculating(true);
                    const coords = activities.map(a => a.coords);
                    let routePath = coords;
                    if (activities.length > 1) routePath = await fetchSmartRoute(coords);
                    setIsCalculating(false);

                    const polyline = L.polyline(routePath, { color: '#A1887F', weight: 4, opacity: 0.7, dashArray: '1, 0', lineCap: 'round', lineJoin: 'round' }).addTo(map);
                    map.fitBounds(polyline.getBounds(), { paddingTopLeft: [50, 50], paddingBottomRight: [50, 200] });
                    polylineRef.current = polyline;

                    const carIcon = L.divIcon({ className: '', html: `<div style="font-size: 32px; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.2)); transform: translateY(-50%);">${getTransportEmoji(activities[0].transport?.type || 'car')}</div>`, iconSize: [40, 40], iconAnchor: [20, 20] });
                    const marker = L.marker(routePath[0], { icon: carIcon, zIndexOffset: 1000 }).addTo(map);
                    markerRef.current = marker;
                    startAnimation(routePath);
                };
                initMap();
            }, [day]); 

            const startAnimation = (routePath) => {
                if (!markerRef.current || !routePath || routePath.length < 2) return;
                setIsPlaying(true);
                setCurrentSegment(null);
                const map = mapInstanceRef.current;
                const latlngs = routePath;
                let startTime = null;
                const totalDuration = 12000; 
                let totalDist = 0;
                const distances = [];
                for(let i=0; i<latlngs.length-1; i++) {
                    const d = map.distance(latlngs[i], latlngs[i+1]);
                    distances.push(d);
                    totalDist += d;
                }
                
                const animate = (timestamp) => {
                    if (!startTime) startTime = timestamp;
                    const progress = (timestamp - startTime) / totalDuration;
                    if (progress < 1) {
                        const currentDist = totalDist * progress;
                        let accumulatedDist = 0;
                        let segmentIndex = 0;
                        for(let i=0; i<distances.length; i++) {
                            if (accumulatedDist + distances[i] >= currentDist) {
                                segmentIndex = i;
                                break;
                            }
                            accumulatedDist += distances[i];
                        }
                        const estimatedActivityIndex = Math.min(activities.length - 2, Math.floor(progress * (activities.length - 1)));
                        const currentActivity = activities[estimatedActivityIndex];
                        const nextActivity = activities[estimatedActivityIndex + 1];
                        
                        if (currentActivity && nextActivity) {
                             const transportInfo = currentActivity.transport || { type: 'walk', duration: '??' };
                             const emoji = getTransportEmoji(transportInfo.type);
                             const newIcon = L.divIcon({ className: '', html: `<div style="font-size: 32px; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.2)); transform: translateY(-50%); transition: all 0.3s;">${emoji}</div>`, iconSize: [40, 40], iconAnchor: [20, 20] });
                             if (markerRef.current.options.icon.options.html !== newIcon.options.html) markerRef.current.setIcon(newIcon);
                             setCurrentSegment({ from: currentActivity.location, to: nextActivity.location, transport: getTransportLabel(transportInfo.type), duration: transportInfo.duration || 'È†ê‰º∞ÊôÇÈñì', emoji: emoji });
                        }
                        const segmentProgress = (currentDist - accumulatedDist) / distances[segmentIndex];
                        const lat = latlngs[segmentIndex][0] + (latlngs[segmentIndex+1][0] - latlngs[segmentIndex][0]) * segmentProgress;
                        const lng = latlngs[segmentIndex][1] + (latlngs[segmentIndex+1][1] - latlngs[segmentIndex][1]) * segmentProgress;
                        markerRef.current.setLatLng([lat, lng]);
                        requestAnimationFrame(animate);
                    } else {
                        markerRef.current.setLatLng(latlngs[latlngs.length-1]);
                        setIsPlaying(false);
                        setCurrentSegment({ from: activities[activities.length-1].location, to: "ÊóÖÁ®ãÁµêÊùü", transport: "ÊäµÈÅî", duration: "-", emoji: "üèÅ" });
                    }
                };
                requestAnimationFrame(animate);
            };

            return (
                <div className="fixed inset-0 bg-[#5D4037]/20 backdrop-blur-sm z-50 flex items-center justify-center p-6">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-5xl p-0 animate-in fade-in zoom-in duration-300 border border-white/50 overflow-hidden flex flex-col h-[85vh] relative">
                        <div className="absolute top-0 left-0 right-0 p-6 flex justify-between items-start z-[500] pointer-events-none">
                            <div className="bg-white/90 backdrop-blur-md px-5 py-3 rounded-2xl shadow-sm border border-[#EFEBE0] pointer-events-auto flex items-center gap-3">
                                <div className="flex items-center gap-2 text-[#5D4037]"><PlayCircle size={20} className="text-[#CFB997]" /><h3 className="text-lg font-bold">{day.date} Ë°åÁ®ãË∑ØÁ∑ö</h3></div>
                                {isCalculating && <div className="flex items-center gap-2 px-3 py-1 bg-[#F5F0E6] rounded-lg text-xs text-[#8D6E63] animate-pulse"><Sparkles size={12} />AI Ê≠£Âú®Ë®àÁÆóÊúÄ‰Ω≥Ë∑ØÂæë...</div>}
                            </div>
                            <button onClick={onClose} className="bg-white/90 backdrop-blur-md p-2 rounded-full shadow-sm border border-[#EFEBE0] text-gray-400 hover:text-[#5D4037] hover:scale-110 transition-all pointer-events-auto"><X size={24} /></button>
                        </div>
                        <div className="flex-1 relative bg-[#fcfbf9] min-h-0">
                            {activities.length > 0 ? <div ref={mapRef} className="w-full h-full z-0"></div> : <div className="flex flex-col items-center justify-center h-full text-[#A1887F]"><p>ÈÄôÂ§©Ê≤íÊúâË∂≥Â§†ÁöÑÂú∞ÈªûË≥áÊñô‰æÜÁî¢ÁîüË∑ØÁ∑öÂúñÂñîÔºÅ</p></div>}
                            {currentSegment && (
                                <div className="absolute bottom-6 left-1/2 -translate-x-1/2 z-[400] w-[90%] max-w-md anim-info-panel bg-white/95 rounded-2xl shadow-lg border border-[#EFEBE0] p-4 flex items-center gap-4 transition-all duration-300">
                                    <div className="w-12 h-12 bg-[#F5F0E6] rounded-full flex items-center justify-center text-2xl shadow-inner ai-calculating relative">{currentSegment.emoji}</div>
                                    <div className="flex-1 min-w-0">
                                        <div className="flex items-center gap-2 text-xs font-bold text-[#A1887F] uppercase tracking-wider mb-1"><span>{currentSegment.transport}</span>{currentSegment.duration !== '-' && <><span className="w-1 h-1 bg-[#D7CCC8] rounded-full"></span><span className="flex items-center gap-1"><Timer size={10}/> {currentSegment.duration}</span></>}</div>
                                        <div className="flex items-center gap-2 text-[#5D4037] font-bold truncate"><span className="truncate">{currentSegment.from}</span><ArrowRight size={14} className="flex-shrink-0 text-[#CFB997]" /><span className="truncate">{currentSegment.to}</span></div>
                                    </div>
                                </div>
                            )}
                        </div>
                        <div className="p-4 bg-white border-t border-[#EFEBE0] flex-shrink-0 flex justify-center z-[500]">
                            <button onClick={() => { const latlngs = polylineRef.current.getLatLngs(); startAnimation(latlngs); }} disabled={isPlaying || activities.length < 2 || isCalculating} className="px-8 py-2.5 bg-[#5D4037] text-white rounded-full font-bold hover:bg-[#4E342E] transition-all shadow-lg flex items-center gap-2 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:scale-100"><PlayCircle size={18} /> {isPlaying ? 'ÊóÖÈÄîÈÄ≤Ë°å‰∏≠...' : 'ÈáçÊñ∞Êí≠Êîæ'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const TravelPlanner = () => {
            const ICON_LIBRARY = [
                { id: 'sightseeing', icon: <Camera size={24} />, label: 'ËßÄÂÖâ', color: 'bg-[#CFB997] text-white' },
                { id: 'food', icon: <Utensils size={24} />, label: 'ÁæéÈ£ü', color: 'bg-[#E6C9A8] text-[#5D4037]' },
                { id: 'transport', icon: <Train size={24} />, label: '‰∫§ÈÄö', color: 'bg-[#D7CCC8] text-[#5D4037]' },
                { id: 'hotel', icon: <Bed size={24} />, label: '‰ΩèÂÆø', color: 'bg-[#DBC1AC] text-[#5D4037]' },
                { id: 'coffee', icon: <Coffee size={24} />, label: 'ÂíñÂï°', color: 'bg-[#C8B7A6] text-white' },
                { id: 'shopping', icon: <ShoppingBag size={24} />, label: 'Ë≥ºÁâ©', color: 'bg-[#F2D7D5] text-[#922B21]' },
                { id: 'entertainment', icon: <Music size={24} />, label: 'Â®õÊ®Ç', color: 'bg-[#D2B4DE] text-[#5B2C6F]' },
                { id: 'flight', icon: <Plane size={24} />, label: 'È£õË°å', color: 'bg-[#B3E5FC] text-[#0277BD]' },
                { id: 'ticket', icon: <Ticket size={24} />, label: 'Á•®Âà∏', color: 'bg-[#FFCCBC] text-[#D84315]' },
                { id: 'gift', icon: <Gift size={24} />, label: 'Á¶ÆÁâ©', color: 'bg-[#F8BBD0] text-[#C2185B]' },
                { id: 'date', icon: <Heart size={24} />, label: 'Á¥ÑÊúÉ', color: 'bg-[#FFCDD2] text-[#C62828]' },
                { id: 'relax', icon: <Smile size={24} />, label: 'ÊîæÈ¨Ü', color: 'bg-[#DCEDC8] text-[#33691E]' },
                { id: 'nature', icon: <Umbrella size={24} />, label: 'Ëá™ÁÑ∂', color: 'bg-[#C5E1A5] text-[#33691E]' },
                { id: 'sea', icon: <Anchor size={24} />, label: 'Êµ∑ÈÇä', color: 'bg-[#B2EBF2] text-[#006064]' },
                { id: 'activity', icon: <Bike size={24} />, label: 'ÈÅãÂãï', color: 'bg-[#FFECB3] text-[#FF6F00]' },
                { id: 'highlight', icon: <Zap size={24} />, label: 'ÈáçÈªû', color: 'bg-[#FFE082] text-[#FF6F00]' },
                { id: 'culture', icon: <BookOpen size={24} />, label: 'ÊñáÂåñ', color: 'bg-[#D1C4E9] text-[#4527A0]' },
                { id: 'morning', icon: <Sun size={24} />, label: 'Êó©Êô®', color: 'bg-[#FFF9C4] text-[#FBC02D]' },
                { id: 'night', icon: <Moon size={24} />, label: 'Â§úÊôö', color: 'bg-[#37474F] text-[#ECEFF1]' },
                { id: 'custom', icon: <Star size={24} />, label: 'ÂÖ∂‰ªñ', color: 'bg-[#E0E0E0] text-[#616161]' },
            ];

            const TRANSPORT_OPTIONS = [
                { id: 'train', label: 'ÁÅ´Ëªä/È´òÈêµ', icon: <Train size={18} />, needCost: true },
                { id: 'mrt', label: 'Êç∑ÈÅã/Âú∞Èêµ', icon: <div className="flex items-center justify-center border-2 border-current rounded" style={{width: 18, height: 18}}><span className="text-[10px] font-bold">M</span></div>, needCost: true },
                { id: 'bus', label: 'ÂÖ¨Ëªä/ÂÆ¢ÈÅã', icon: <Bus size={18} />, needCost: true },
                { id: 'taxi', label: 'Ë®àÁ®ãËªä/Uber', icon: <Car size={18} />, needCost: true },
                { id: 'car', label: 'Ëá™Ë°åÈñãËªä', icon: <Car size={18} />, needCost: false },
                { id: 'bike', label: 'È®éËªä', icon: <Bike size={18} />, needCost: false },
                { id: 'walk', label: 'Ê≠•Ë°å', icon: <Footprints size={18} />, needCost: false },
                { id: 'flight', label: 'È£õÊ©ü', icon: <Plane size={18} />, needCost: true },
                { id: 'ship', label: 'ËàπÈÅã', icon: <Anchor size={18} />, needCost: true },
            ];

            const initialTripData = {
                title: "Âè∞ÂåóËºïÊóÖË°å",
                destination: "Âè∞ÁÅ£, Âè∞Âåó",
                startDate: "2024-05-20",
                endDate: "2024-05-22",
                days: [
                {
                    id: 1,
                    date: "05/20 Day 1",
                    label: "ÂüéÂ∏ÇÊé¢Á¥¢",
                    activities: [
                    { id: 101, time: "10:00", type: "transport", location: "Âè∞ÂåóÁÅ´ËªäÁ´ô", coords: [25.0478, 121.5170], note: "ÊäµÈÅîÂè∞ÂåóÔºåÂâçÂæÄÈ£ØÂ∫óÂØÑÊîæË°åÊùé", cost: 0, transport: { type: 'mrt', duration: '15', cost: 25 } },
                    { id: 102, time: "12:00", type: "food", location: "ÈòúÊù≠Ë±ÜÊºø", coords: [25.0442, 121.5248], note: "ÂøÖÂêÉÂéöÁáíÈ§ÖÔºåÊéíÈöäÈ†êË®à 30 ÂàÜÈêò", cost: 150, transport: { type: 'walk', duration: '10', cost: 0 } },
                    ]
                },
                {
                    id: 2,
                    date: "05/21 Day 2",
                    label: "Ê≠∑Âè≤ËàáÂ§ïÈôΩ",
                    activities: [
                    { id: 201, time: "09:30", type: "ticket", location: "ÂúãÁ´ãÊïÖÂÆÆÂçöÁâ©Èô¢", coords: [25.1024, 121.5486], note: "ÂèÉËßÄÁø†ÁéâÁôΩËèúÔºåÈ†êË®àÂÅúÁïô 3 Â∞èÊôÇ", cost: 350 },
                    ]
                },
                { id: 3, date: "05/22 Day 3", label: "Ê∫ñÂÇôËøîÂÆ∂", activities: [] }
                ]
            };

            const [trip, setTrip] = useState(initialTripData);
            const [activeDayId, setActiveDayId] = useState(1);
            const [isEditing, setIsEditing] = useState(false);
            const [editingActivity, setEditingActivity] = useState(null);
            const [editingDayTitle, setEditingDayTitle] = useState(false);
            const [tempDayTitle, setTempDayTitle] = useState("");
            const [showAddModal, setShowAddModal] = useState(false);
            const [showTransportModal, setShowTransportModal] = useState(false);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [showMapModal, setShowMapModal] = useState(false); 
            const [showRouteAnimModal, setShowRouteAnimModal] = useState(false); 
            
            const [newActivityForm, setNewActivityForm] = useState({ time: "12:00", type: "sightseeing", location: "", note: "", cost: "" });
            const [transportForm, setTransportForm] = useState({ dayId: null, activityId: null, type: 'train', duration: '', cost: '' });
            const [settingsForm, setSettingsForm] = useState({ title: "", destination: "", startDate: "", endDate: "" });
            
            // Êñ∞Â¢ûÔºöÁ∑®ËºØÊ®°Âºè‰∏ãÁöÑÂ∫ßÊ®ôÁãÄÊÖãÔºåÁî®ÊñºÈ°ØÁ§∫ÂÆö‰ΩçÁµêÊûú
            const [editingCoordsStatus, setEditingCoordsStatus] = useState(null); // 'success', 'error', 'loading', null

            const [sidebarWidth, setSidebarWidth] = useState(320);
            const [isResizing, setIsResizing] = useState(false);
            const sidebarRef = useRef(null);

            const getGoogleMapLink = (location) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}`;
            const getIconData = (type) => ICON_LIBRARY.find(item => item.id === type) || ICON_LIBRARY[ICON_LIBRARY.length - 1];
            const getTransportOption = (type) => TRANSPORT_OPTIONS.find(t => t.id === type) || TRANSPORT_OPTIONS[0];
            const formatDateRange = (start, end) => !start ? "Êú™Ë®≠ÂÆöÊó•Êúü" : `${start.replace(/-/g, '/')} - ${end ? end.replace(/-/g, '/') : '?'}`;
            const formatDateMMDD = (dateObj) => `${(dateObj.getMonth() + 1).toString().padStart(2, '0')}/${dateObj.getDate().toString().padStart(2, '0')}`;

            const startResizing = (e) => { e.preventDefault(); setIsResizing(true); };
            const stopResizing = () => setIsResizing(false);
            const resize = (e) => { if (isResizing) setSidebarWidth(Math.max(250, Math.min(600, e.clientX))); };
            useEffect(() => { window.addEventListener('mousemove', resize); window.addEventListener('mouseup', stopResizing); return () => { window.removeEventListener('mousemove', resize); window.removeEventListener('mouseup', stopResizing); }; }, [isResizing]);

            const deleteDay = (dayId) => {
                if (trip.days.length === 0) return;
                if (!window.confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÊï¥Â§©ÁöÑË°åÁ®ãÂóéÔºü")) return;
                const newDays = trip.days.filter(d => d.id !== dayId).map((day, index) => ({ ...day, date: `${day.date.split(' ')[0]} Day ${index + 1}` }));
                setTrip(prev => ({ ...prev, days: newDays }));
                if (newDays.length === 0) setActiveDayId(null); else setActiveDayId(newDays[0].id);
            };

            const saveDayTitle = () => { setTrip(p => ({...p, days: p.days.map(d => d.id === activeDayId ? { ...d, label: tempDayTitle } : d)})); setEditingDayTitle(false); };
            const deleteActivity = (dayId, actId) => setTrip(p => ({...p, days: p.days.map(day => day.id === dayId ? { ...day, activities: day.activities.filter(a => a.id !== actId) } : day)}));

            // Âº∑ÂåñÁâà Save: Á¢∫‰øùÂ∫ßÊ®ôÊ≠£Á¢∫Êõ¥Êñ∞
            const saveActivityEdit = async (dayId, actId, newData) => {
                let coords = null;
                // Â¶ÇÊûúÊúâ‰øÆÊîπÂú∞ÈªûÔºåÂº∑Âà∂ÈáçÊñ∞ÊäìÂèñÂ∫ßÊ®ô
                if (newData.location) {
                     coords = await fetchCoordinates(newData.location);
                }
                
                setTrip(p => ({
                    ...p, 
                    days: p.days.map(day => {
                        if (day.id === dayId) {
                            const updatedActivities = day.activities.map(act => {
                                if (act.id === actId) {
                                    const updatedAct = { ...act, ...newData };
                                    if (coords) updatedAct.coords = coords;
                                    return updatedAct;
                                }
                                return act;
                            });
                            updatedActivities.sort((a, b) => a.time.localeCompare(b.time));
                            return { ...day, activities: updatedActivities };
                        }
                        return day;
                    })
                }));
                setEditingActivity(null);
                setEditingCoordsStatus(null);
            };
            
            // ËôïÁêÜÂú∞ÈªûËº∏ÂÖ•Ê°ÜÂ§±ÂéªÁÑ¶ÈªûÔºåËá™ÂãïÊ™¢Êü•Â∫ßÊ®ô
            const handleLocationBlur = async (e, isNew = false) => {
                const val = e.target.value;
                if(!val) return;
                setEditingCoordsStatus('loading');
                const coords = await fetchCoordinates(val);
                if(coords) {
                    setEditingCoordsStatus('success');
                } else {
                    setEditingCoordsStatus('error');
                }
            };

            const saveTransport = () => {
                const { dayId, activityId, type, duration, cost } = transportForm;
                const transportData = { type, duration, cost };
                if (!getTransportOption(type).needCost) transportData.cost = 0;
                setTrip(p => ({...p, days: p.days.map(day => day.id === dayId ? { ...day, activities: day.activities.map(act => act.id === activityId ? { ...act, transport: transportData } : act) } : day)}));
                setShowTransportModal(false);
            };

            const openTransportModal = (dayId, activityId, currentTransport) => {
                setTransportForm({ dayId, activityId, type: currentTransport?.type || 'train', duration: currentTransport?.duration || '', cost: currentTransport?.cost || '' });
                setShowTransportModal(true);
            };

            const saveSettings = () => {
                // ... (Settings logic same as before) ...
                // Simply updating state logic here to save space, assuming same logic
                const { title, destination, startDate, endDate } = settingsForm;
                let newDays = [...trip.days];
                if (startDate && endDate) {
                    const start = new Date(startDate); const end = new Date(endDate);
                    const diffDays = Math.ceil(Math.abs(end - start) / (1000 * 60 * 60 * 24)) + 1;
                    if (!isNaN(diffDays) && diffDays > 0) {
                        const generatedDays = [];
                        for (let i = 0; i < diffDays; i++) {
                            const d = new Date(start); d.setDate(start.getDate() + i);
                            const existing = trip.days[i];
                            generatedDays.push(existing ? { ...existing, date: `${formatDateMMDD(d)} Day ${i + 1}` } : { id: Date.now() + i, date: `${formatDateMMDD(d)} Day ${i + 1}`, label: "Ëá™Áî±Ê¥ªÂãï", activities: [] });
                        }
                        newDays = generatedDays;
                    }
                }
                setTrip({ ...trip, title, destination, startDate, endDate, days: newDays });
                if(newDays.length > 0 && !newDays.find(d => d.id === activeDayId)) setActiveDayId(newDays[0].id);
                setShowSettingsModal(false);
            };
            
            const openSettingsModal = () => { setSettingsForm({ title: trip.title, destination: trip.destination, startDate: trip.startDate, endDate: trip.endDate }); setShowSettingsModal(true); };

            const handleAddActivity = async () => {
                if (!newActivityForm.location) { alert("Ë´ãËº∏ÂÖ•Âú∞ÈªûÂêçÁ®±ÔºÅ"); return; }
                let newCoords = await fetchCoordinates(newActivityForm.location);
                if (!newCoords) {
                    // Fallback simulation
                    const currentActivities = trip.days.find(d => d.id === activeDayId)?.activities || [];
                    const last = currentActivities[currentActivities.length - 1];
                    newCoords = [25.0478, 121.5170];
                    if (last && last.coords) newCoords = [last.coords[0] + (Math.random() - 0.5) * 0.05, last.coords[1] + (Math.random() - 0.5) * 0.05];
                }
                const newAct = { id: Date.now(), ...newActivityForm, coords: newCoords, completed: false };
                setTrip(p => ({...p, days: p.days.map(d => d.id === activeDayId ? { ...d, activities: [...d.activities, newAct].sort((a, b) => a.time.localeCompare(b.time)) } : d)}));
                setShowAddModal(false); setNewActivityForm({ time: "12:00", type: "sightseeing", location: "", note: "", cost: "" });
            };

            const handleAddDay = () => {
                const newDayId = Date.now(); const dayCount = trip.days.length + 1;
                let dateStr = "";
                if (trip.startDate) { const s = new Date(trip.startDate); if(!isNaN(s)) { s.setDate(s.getDate() + dayCount - 1); dateStr = formatDateMMDD(s); } }
                setTrip(p => ({...p, days: [...p.days, { id: newDayId, date: `${dateStr} Day ${dayCount}`, label: "Êñ∞ÁöÑ‰∏ÄÂ§©", activities: [] }] }));
                setActiveDayId(newDayId);
            };

            const handleExportImage = () => {
                const element = document.body; 
                html2canvas(element, { scrollY: -window.scrollY }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `trip_plan_${new Date().toISOString().slice(0,10)}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                });
            };

            const calculateStats = () => {
                let cost = 0, acts = 0, dur = 0;
                trip.days.forEach(d => { acts += d.activities.length; d.activities.forEach(a => { if(a.cost) cost += +a.cost; if(a.transport) { if(a.transport.cost) cost += +a.transport.cost; if(a.transport.duration) dur += +a.transport.duration; } }); });
                const h = Math.floor(dur/60), m = dur%60;
                return { totalCost: cost, totalActivities: acts, timeString: h>0?`${h}ÊôÇ${m}ÂàÜ`:`${m}ÂàÜ` };
            };
            const stats = calculateStats();
            const activeDayData = trip.days.find(d => d.id === activeDayId);

            return (
                <div className="flex h-screen bg-[#FDFBF7] text-[#5D4037] font-sans selection:bg-[#CFB997] selection:text-white overflow-hidden">
                    <aside ref={sidebarRef} style={{ width: sidebarWidth }} className="flex-shrink-0 bg-[#F5F0E6] flex flex-col border-r border-[#EFEBE0] shadow-[4px_0_24px_rgba(93,64,55,0.03)] z-20 relative transition-width duration-75 ease-linear">
                        <div className="p-8 pb-4 animate-in fade-in slide-in-from-left-4 duration-700 group">
                            <div className="flex items-center gap-2 mb-2 opacity-60 text-xs tracking-widest uppercase font-bold text-[#8D6E63]"><MapPin size={12} />{trip.destination}</div>
                            <h1 className="text-3xl font-bold text-[#5D4037] mb-4 leading-tight">{trip.title}</h1>
                            <div className="flex items-center gap-2">
                                <div className="flex items-center gap-2 text-sm text-[#8D6E63] bg-[#EFEBE0] py-2 px-3 rounded-lg inline-flex"><Calendar size={14} /><span>{formatDateRange(trip.startDate, trip.endDate)}</span></div>
                                <button onClick={openSettingsModal} className="p-2 bg-white rounded-lg shadow-sm text-[#CFB997] hover:bg-[#CFB997] hover:text-white transition-all" title="ÊóÖÁ®ãË®≠ÂÆö"><Settings size={16} /></button>
                                <button onClick={() => setShowMapModal(true)} className="p-2 bg-white rounded-lg shadow-sm text-[#CFB997] hover:bg-[#CFB997] hover:text-white transition-all" title="Ê™¢Ë¶ñË∑ØÁ∑öÂú∞Âúñ"><MapIcon size={16} /></button>
                                <button onClick={handleExportImage} className="p-2 bg-white rounded-lg shadow-sm text-[#CFB997] hover:bg-[#CFB997] hover:text-white transition-all" title="‰∏ãËºâË°åÁ®ãÂúñÁâá"><Download size={16} /></button>
                            </div>
                        </div>
                        <div className="px-6 mb-2">
                            <div className="bg-white/60 rounded-xl p-3 border border-[#EFEBE0] grid grid-cols-3 gap-2 text-center">
                                <div><div className="text-[10px] text-[#A1887F] mb-1">Á∏ΩÈ†êÁÆó</div><div className="text-sm font-bold text-[#5D4037]">${stats.totalCost}</div></div>
                                <div><div className="text-[10px] text-[#A1887F] mb-1">ÊôØÈªûÊï∏</div><div className="text-sm font-bold text-[#5D4037]">{stats.totalActivities}</div></div>
                                <div><div className="text-[10px] text-[#A1887F] mb-1">ÁßªÂãï</div><div className="text-sm font-bold text-[#5D4037]">{stats.timeString}</div></div>
                            </div>
                        </div>
                        <nav className="flex-1 overflow-y-auto px-6 py-4 space-y-3 scrollbar-hide">
                            <div className="flex justify-between items-center mb-2 px-2"><div className="text-xs font-bold text-[#A1887F] uppercase tracking-wider">Itinerary</div></div>
                            {trip.days.map((day, idx) => (
                                <div key={day.id} className="relative group/item animate-in fade-in slide-in-from-left-8 duration-500 fill-mode-backwards" style={{ animationDelay: `${idx * 100}ms` }}>
                                    <button onClick={() => setActiveDayId(day.id)} className={`w-full text-left px-5 py-4 rounded-xl transition-all duration-300 relative overflow-hidden group/btn ${activeDayId === day.id ? 'bg-white shadow-md border border-[#EFEBE0] translate-x-2' : 'hover:bg-[#EFEBE0] hover:translate-x-1 border border-transparent'}`}>
                                        <div className="flex items-center justify-between relative z-10">
                                            <div><div className={`text-xs font-bold mb-1 transition-colors ${activeDayId === day.id ? 'text-[#CFB997]' : 'text-[#A1887F]'}`}>{day.date}</div><div className="font-bold text-lg text-[#5D4037] truncate w-32">{day.label}</div></div>
                                            {activeDayId === day.id && <div className="h-2 w-2 rounded-full bg-[#CFB997] animate-pulse" />}
                                        </div>
                                    </button>
                                </div>
                            ))}
                            <button onClick={handleAddDay} className="w-full py-3 mt-4 border-2 border-dashed border-[#D7CCC8] rounded-xl text-[#A1887F] hover:border-[#CFB997] hover:text-[#CFB997] hover:bg-white/50 transition-all active:scale-95 flex items-center justify-center gap-2 text-sm font-bold"><Plus size={16} /> Êñ∞Â¢ûÂ§©Êï∏</button>
                        </nav>
                        <div className="p-6 border-t border-[#E0D8CE] bg-[#F0EAE0]">
                            <div className="flex gap-3">
                                <button className="flex-1 py-3 bg-[#CFB997] text-white rounded-lg hover:bg-[#BCAAA4] transition-all hover:-translate-y-0.5 font-bold shadow-sm flex items-center justify-center gap-2 active:scale-95"><Share2 size={18} /> ÂàÜ‰∫´</button>
                                <button onClick={() => setIsEditing(!isEditing)} className={`px-4 rounded-lg border border-[#D7CCC8] transition-colors flex items-center justify-center active:scale-95 ${isEditing ? 'bg-[#5D4037] text-white' : 'bg-white text-[#5D4037] hover:bg-[#FAF9F6]'}`} title="Á∑®ËºØÊ®°Âºè"><Edit3 size={18} /></button>
                            </div>
                        </div>
                    </aside>
                    <div className="w-4 bg-[#FDFBF7] hover:bg-[#EFEBE0] cursor-col-resize flex items-center justify-center z-30 transition-colors group relative -ml-2" onMouseDown={startResizing}>
                        <div className="w-[1px] h-8 bg-[#D7CCC8] group-hover:bg-[#8D6E63]"></div>
                    </div>
                    <main className="flex-1 overflow-y-auto relative bg-dots-pattern">
                        <div className="absolute inset-0 opacity-[0.02] pointer-events-none" style={{ backgroundImage: 'radial-gradient(#5D4037 1px, transparent 1px)', backgroundSize: '24px 24px' }}></div>
                        <div key={activeDayId} className="max-w-4xl mx-auto px-12 py-16 animate-in fade-in slide-in-from-bottom-8 duration-500 ease-out">
                            {trip.days.length === 0 || !activeDayData ? (
                                <div className="flex flex-col items-center justify-center min-h-[60vh] animate-in zoom-in duration-500">
                                    <div className="p-8 rounded-full bg-[#F5F0E6] mb-6 animate-pulse"><Calendar size={48} className="text-[#8D6E63]" /></div>
                                    <h2 className="text-3xl font-bold text-[#5D4037] mb-4">ÈáçÊñ∞ÈñãÂßãË¶èÂäÉ</h2>
                                    <button onClick={handleAddDay} className="px-8 py-4 bg-[#CFB997] text-white rounded-full shadow-lg hover:bg-[#BCAAA4] transition-all hover:scale-105 active:scale-95 font-bold text-lg flex items-center gap-2"><Plus size={24} /> Âª∫Á´ãÁ¨¨‰∏ÄÂ§©Ë°åÁ®ã</button>
                                </div>
                            ) : (
                                <>
                                    <div className="mb-12 flex items-end justify-between border-b border-[#EFEBE0] pb-6">
                                        <div className="flex-1">
                                            <span className="text-[#CFB997] font-bold text-lg block mb-1 animate-in fade-in duration-700">{activeDayData?.date}</span>
                                            {editingDayTitle ? (
                                                <div className="flex items-center gap-2"><input type="text" autoFocus value={tempDayTitle} onChange={(e) => setTempDayTitle(e.target.value)} className="text-4xl font-bold text-[#5D4037] bg-transparent border-b-2 border-[#CFB997] focus:outline-none w-full max-w-md" onKeyDown={(e) => e.key === 'Enter' && saveDayTitle()} /><button onClick={saveDayTitle} className="p-2 bg-[#CFB997] text-white rounded-full hover:bg-[#BCAAA4] animate-in zoom-in"><Save size={20} /></button></div>
                                            ) : (
                                                <h2 className="text-4xl font-bold text-[#5D4037] cursor-pointer hover:text-[#8D6E63] group flex items-center gap-3 transition-colors duration-300" onClick={() => { setTempDayTitle(activeDayData?.label); setEditingDayTitle(true); }}>{activeDayData?.label}<Edit3 size={24} className="opacity-0 group-hover:opacity-30 transition-opacity text-[#CFB997] duration-300" /></h2>
                                            )}
                                        </div>
                                        <div className="flex flex-col items-end gap-2">
                                            <div className="flex gap-2">
                                                <button onClick={(e) => { e.stopPropagation(); setShowRouteAnimModal(true); }} className="flex items-center gap-1 text-[#CFB997] hover:text-white hover:bg-[#CFB997] px-3 py-1.5 rounded-lg transition-colors text-sm border border-[#CFB997] active:scale-95"><PlayCircle size={16} /> Êí≠ÊîæË∑ØÁ∑ö</button>
                                                <button onClick={(e) => { e.stopPropagation(); deleteDay(activeDayData.id); }} className="flex items-center gap-1 text-red-300 hover:text-red-500 hover:bg-red-50 px-3 py-1.5 rounded-lg transition-colors text-sm border border-transparent hover:border-red-100 active:scale-95"><Trash2 size={16} /> Âà™Èô§ÈÄô‰∏ÄÂ§©</button>
                                            </div>
                                            <div className="text-[#A1887F] text-sm">{activeDayData?.activities.length} ÂÄãË°åÁ®ã</div>
                                        </div>
                                    </div>
                                    {activeDayData.activities.length === 0 ? (
                                        <div className="flex flex-col items-center justify-center py-32 border-2 border-dashed border-[#EFEBE0] rounded-3xl bg-white/50 animate-in fade-in zoom-in duration-500">
                                            <Coffee size={64} className="mb-6 text-[#D7CCC8]" /><p className="text-xl text-[#8D6E63] font-medium mb-2">ÈÄô‰∏ÄÂ§©ÈÇÑÊòØ‰∏ÄÂºµÁôΩÁ¥ô</p>
                                            <button onClick={() => setShowAddModal(true)} className="px-8 py-3 bg-[#CFB997] text-white rounded-full shadow-lg hover:bg-[#BCAAA4] hover:shadow-xl hover:-translate-y-1 transition-all flex items-center gap-2 font-bold active:scale-95"><Plus size={20} /> Êñ∞Â¢ûÁ¨¨‰∏ÄÂÄãË°åÁ®ã</button>
                                        </div>
                                    ) : (
                                        <div className="space-y-0 relative pl-4 pb-20">
                                            {activeDayData.activities.map((activity, index) => {
                                                const iconData = getIconData(activity.type);
                                                const nextActivity = activeDayData.activities[index + 1];
                                                const hasTransport = !!activity.transport;
                                                const transportInfo = activity.transport ? getTransportOption(activity.transport.type) : null;
                                                const hasCost = activity.cost && Number(activity.cost) > 0;
                                                return (
                                                    <div key={activity.id} className="relative animate-in slide-in-from-bottom-4 duration-700 fill-mode-backwards" style={{ animationDelay: `${index * 150}ms` }}>
                                                        <div className="flex gap-8 group relative z-10">
                                                            <div className="flex flex-col items-center min-w-[60px] pt-2 relative">
                                                                <div className={`w-14 h-14 rounded-2xl rotate-3 flex items-center justify-center shadow-md border-[3px] border-[#FDFBF7] transition-all duration-300 group-hover:rotate-0 group-hover:scale-110 group-hover:shadow-lg ${iconData.color}`}>{iconData.icon}</div>
                                                                <CustomTimePicker value={activity.time} onChange={null} onComplete={(newTime) => saveActivityEdit(activeDayId, activity.id, { time: newTime })} mode="minimal" showIcon={false} placement="top" />
                                                            </div>
                                                            <div className="flex-1 bg-white p-6 rounded-2xl shadow-[0_4px_20px_rgba(93,64,55,0.05)] border border-[#EFEBE0] group-hover:border-[#CFB997]/50 group-hover:shadow-[0_8px_30px_rgba(93,64,55,0.08)] transition-all duration-300 relative overflow-hidden mb-8 transform hover:-translate-y-1 hover:shadow-lg">
                                                                <div className="absolute top-0 left-0 w-1 h-full bg-[#EFEBE0] group-hover:bg-[#CFB997] transition-colors duration-300"></div>
                                                                {editingActivity === activity.id ? (
                                                                    <div className="pl-4 space-y-4">
                                                                        <div className="flex gap-4">
                                                                            <div className="w-1/3"><CustomTimePicker value={activity.time} onChange={(val) => { const input = document.getElementById(`edit-time-${activity.id}`); if(input) input.value = val; }} /><input type="hidden" defaultValue={activity.time} id={`edit-time-${activity.id}`} /></div>
                                                                            <div className="flex-1 relative">
                                                                                <input type="text" defaultValue={activity.location} id={`edit-loc-${activity.id}`} className="w-full bg-[#FAFAFA] border border-[#E0E0E0] rounded-xl p-3 font-bold text-[#5D4037] pr-10" onBlur={(e) => handleLocationBlur(e)} />
                                                                                {editingCoordsStatus && <div className="absolute right-3 top-3">{editingCoordsStatus === 'loading' ? <Sparkles className="animate-spin text-[#CFB997]" size={18}/> : editingCoordsStatus === 'success' ? <CheckCircle2 className="text-green-500" size={18}/> : <AlertCircle className="text-red-400" size={18}/>}</div>}
                                                                            </div>
                                                                        </div>
                                                                        <div><label className="text-xs text-[#A1887F] mb-1 block">ÈñÄÁ•®/Ë≤ªÁî® (0ÁÇ∫ÂÖçË≤ª)</label><div className="relative"><Banknote size={14} className="absolute left-3 top-2.5 text-[#CFB997]" /><input type="number" defaultValue={activity.cost} id={`edit-cost-${activity.id}`} placeholder="0" className="w-full bg-[#FAFAFA] border border-[#E0E0E0] rounded p-2 pl-9 text-sm" /></div></div>
                                                                        <textarea defaultValue={activity.note} id={`edit-note-${activity.id}`} className="w-full bg-[#FAFAFA] border border-[#E0E0E0] rounded p-2 text-sm resize-none h-20" />
                                                                        <div className="flex justify-end gap-2 pt-2">
                                                                            <button onClick={() => { setEditingActivity(null); setEditingCoordsStatus(null); }} className="px-3 py-1 text-sm text-gray-400 hover:text-gray-600">ÂèñÊ∂à</button>
                                                                            <button onClick={() => { const timeInput = document.getElementById(`edit-time-${activity.id}`); const time = timeInput.value; const location = document.getElementById(`edit-loc-${activity.id}`).value; const note = document.getElementById(`edit-note-${activity.id}`).value; const cost = document.getElementById(`edit-cost-${activity.id}`).value; saveActivityEdit(activeDayId, activity.id, { time, location, note, cost }); }} className="px-4 py-1 text-sm bg-[#CFB997] text-white rounded hover:bg-[#BCAAA4]"><Save size={14} /> ÂÑ≤Â≠ò</button>
                                                                        </div>
                                                                    </div>
                                                                ) : (
                                                                    <div className="pl-4 flex justify-between items-start gap-6">
                                                                        <div className="flex-1">
                                                                            <div className="flex items-center gap-2 mb-2"><span className="text-[10px] uppercase tracking-wider font-bold text-[#A1887F] bg-[#F5F0E6] px-2 py-0.5 rounded transition-colors group-hover:bg-[#EFEBE0]">{iconData.label}</span>{hasCost ? <span className="text-[10px] font-bold text-[#5D4037] bg-[#FFF3E0] px-2 py-0.5 rounded border border-[#FFE0B2] flex items-center gap-1"><Banknote size={10} /> ${activity.cost}</span> : <span className="text-[10px] font-bold text-[#689F38] bg-[#F1F8E9] px-2 py-0.5 rounded border border-[#DCEDC8]">ÂÖçË≤ª / ÂÖçÁ•®</span>}</div>
                                                                            <h3 className="text-2xl font-bold text-[#5D4037] mb-2">{activity.location}</h3><p className="text-[#8D6E63] leading-relaxed whitespace-pre-line">{activity.note}</p>
                                                                            <div className="mt-4 pt-4 border-t border-[#FAFAFA] flex items-center"><a href={getGoogleMapLink(activity.location)} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-2 text-sm font-medium text-[#CFB997] hover:text-[#8D6E63] transition-colors group/link bg-[#FAFAFA] hover:bg-[#F5F0E6] px-3 py-1.5 rounded-lg"><MapIcon size={16} /><span>Âú® Google Maps ‰∏äÊü•Áúã {activity.location}</span><ExternalLink size={12} className="opacity-50 group-hover/link:opacity-100 transition-opacity" /></a></div>
                                                                        </div>
                                                                        <div className={`flex flex-col gap-2 opacity-0 group-hover:opacity-100 transition-all duration-300 ${isEditing ? 'opacity-100' : ''}`}><button onClick={() => setEditingActivity(activity.id)} className="p-2 text-gray-400 hover:text-[#CFB997] hover:bg-[#F5F0E6] rounded-lg transition-colors active:scale-95"><Edit3 size={18} /></button><button onClick={() => deleteActivity(activeDayId, activity.id)} className="p-2 text-gray-400 hover:text-red-400 hover:bg-red-50 rounded-lg transition-colors active:scale-95"><Trash2 size={18} /></button></div>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                        {nextActivity && (
                                                            <div className="absolute left-[29px] top-[70px] bottom-[-20px] w-0.5 bg-[#E0D8CE] flex flex-col items-center justify-center z-10">
                                                                <div className="relative z-10 my-auto">
                                                                    <button onClick={(e) => { e.stopPropagation(); openTransportModal(activeDayId, activity.id, activity.transport); }} className={`flex flex-row items-center gap-2 px-3 py-1.5 rounded-full border shadow-sm transition-all hover:scale-110 active:scale-95 whitespace-nowrap ${hasTransport ? 'bg-white border-[#D7CCC8] text-[#5D4037]' : 'bg-[#FDFBF7] border-[#EFEBE0] text-[#D7CCC8] hover:border-[#CFB997] hover:text-[#CFB997]'}`} title="Ë®≠ÂÆö‰∫§ÈÄöÊñπÂºè" style={{pointerEvents: 'auto'}}>{hasTransport ? <><div className="text-[#8D6E63]">{transportInfo?.icon}</div><span className="text-xs font-bold text-[#8D6E63] flex items-center whitespace-nowrap">{activity.transport.duration} ÂàÜ</span>{(transportInfo.needCost && activity.transport.cost > 0) && <span className="text-xs text-[#A1887F] bg-[#F5F0E6] px-1.5 rounded ml-1 flex items-center whitespace-nowrap">${activity.transport.cost} ÂÖÉ</span>}</> : <><Plus size={12} /><Footprints size={12} className="rotate-90 opacity-60" /></>}</button>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                            <div className="flex justify-center pt-8 relative z-10"><button onClick={() => setShowAddModal(true)} className="flex items-center gap-2 px-8 py-3 bg-white border border-[#CFB997] text-[#CFB997] rounded-full shadow-sm hover:bg-[#CFB997] hover:text-white transition-all hover:scale-105 active:scale-95 font-bold group"><Plus size={18} className="group-hover:rotate-90 transition-transform" /> Âä†ÂÖ•‰∏ã‰∏ÄÂÄãË°åÁ®ã</button></div>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    </main>

                    {showMapModal && (
                        <div className="fixed inset-0 bg-[#5D4037]/30 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-3xl shadow-2xl w-full max-w-lg p-0 animate-in fade-in zoom-in duration-200 border border-[#EFEBE0] overflow-hidden">
                                <div className="bg-[#F5F0E6] px-6 py-4 flex justify-between items-center border-b border-[#EFEBE0]"><div className="flex items-center gap-2 text-[#5D4037]"><MapIcon size={20} /><h3 className="text-xl font-bold">Ë∑ØÁ∑öÈ†êË¶Ω</h3></div><button onClick={() => setShowMapModal(false)} className="text-gray-400 hover:text-[#5D4037]"><X size={20} /></button></div>
                                <div className="p-6">
                                    <p className="text-sm text-[#8D6E63] mb-4 leading-relaxed">Á≥ªÁµ±Â∞áËá™ÂãïÂΩôÊï¥ÊÇ®ÈÄôË∂üÊóÖÁ®ã‰∏≠ÊâÄÊúâÁöÑÊôØÈªûËàáÊ¥ªÂãïÔºå‰∏¶ÁîüÊàê‰∏ÄÊ¢ùÊúÄ‰Ω≥ÂåñÁöÑË∑ØÁ∑öÂúñ„ÄÇ</p>
                                    <div className="bg-[#FAFAFA] rounded-xl p-4 border border-[#E0E0E0] max-h-48 overflow-y-auto custom-scrollbar mb-6">
                                        <h4 className="text-xs font-bold text-[#A1887F] mb-2 uppercase">ÈÄîÁ∂ìÂú∞ÈªûÊ∏ÖÂñÆ</h4>
                                        <div className="space-y-2">
                                            {trip.days.flatMap(day => day.activities).length > 0 ? (trip.days.flatMap(day => day.activities.map(act => act.location)).filter(l => l).map((loc, idx) => <div key={idx} className="flex items-center gap-2 text-sm text-[#5D4037]"><div className="w-1.5 h-1.5 rounded-full bg-[#CFB997]"></div>{loc}</div>)) : <div className="text-sm text-gray-400 italic">ÁõÆÂâçÈÇÑÊ≤íÊúâ‰ªª‰ΩïË°åÁ®ãÂú∞Èªû...</div>}
                                        </div>
                                    </div>
                                    <a href={generateMapRouteLink()} target="_blank" rel="noopener noreferrer" className="w-full bg-[#4285F4] text-white py-3 rounded-xl font-bold hover:bg-[#3367D6] transition-all shadow-md flex items-center justify-center gap-2 active:scale-95"><Navigation size={18} /> Âú® Google Maps ‰∏äÈñãÂïüÂÆåÊï¥Ë∑ØÁ∑ö</a>
                                </div>
                            </div>
                        </div>
                    )}

                    {showRouteAnimModal && activeDayData && <RouteAnimationModal day={activeDayData} onClose={() => setShowRouteAnimModal(false)} transportOptions={TRANSPORT_OPTIONS} />}

                    {showAddModal && (
                        <div className="fixed inset-0 bg-[#5D4037]/30 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-3xl shadow-2xl w-full max-w-2xl p-0 animate-in fade-in zoom-in duration-300 border border-[#EFEBE0] overflow-hidden flex flex-col max-h-[90vh]">
                                <div className="px-8 py-6 border-b border-[#FAFAFA] flex justify-between items-center bg-white sticky top-0 z-10"><h3 className="text-2xl font-bold text-[#5D4037]">Êñ∞Â¢ûË°åÁ®ã</h3><button onClick={() => setShowAddModal(false)} className="text-gray-400 hover:text-gray-600 transition-colors bg-[#FAFAFA] p-2 rounded-full hover:bg-[#F5F0E6]"><X size={20} /></button></div>
                                <div className="p-8 overflow-y-auto custom-scrollbar flex-1">
                                    <div className="space-y-6">
                                        <div><label className="block text-xs font-bold text-[#8D6E63] uppercase tracking-wide mb-2">ÊôÇÈñì</label><CustomTimePicker value={newActivityForm.time} onChange={(val) => setNewActivityForm({...newActivityForm, time: val})} /></div>
                                        <div><label className="block text-xs font-bold text-[#8D6E63] uppercase tracking-wide mb-2">ÈÅ∏Êìá‰∏ÄÂºµË≤ºÁ¥ô (‰ª£Ë°®Ë°åÁ®ãÈ°ûÂûã)</label><div className="grid grid-cols-4 sm:grid-cols-6 gap-3 max-h-56 overflow-y-auto p-1">{ICON_LIBRARY.map((item) => <button key={item.id} onClick={() => setNewActivityForm({...newActivityForm, type: item.id})} className={`flex flex-col items-center justify-center p-3 rounded-2xl border transition-all duration-200 gap-2 aspect-square active:scale-95 ${newActivityForm.type === item.id ? 'bg-[#F5F0E6] border-[#CFB997] ring-4 ring-[#CFB997]/20 scale-105 shadow-md' : 'bg-white border-[#EFEBE0] hover:border-[#D7CCC8] hover:bg-[#FAFAFA] opacity-70 hover:opacity-100'}`}><div className={`w-10 h-10 rounded-full flex items-center justify-center ${item.color}`}>{item.icon}</div><span className="text-[10px] font-bold text-[#8D6E63]">{item.label}</span></button>)}</div></div>
                                        <div><label className="block text-xs font-bold text-[#8D6E63] uppercase tracking-wide mb-2">Âú∞Èªû / Ë°åÁ®ãÂêçÁ®±</label><div className="relative"><input type="text" placeholder="‰æãÂ¶Ç: Âè∞ÂåóÁÅ´ËªäÁ´ô" value={newActivityForm.location} onChange={(e) => setNewActivityForm({...newActivityForm, location: e.target.value})} className="w-full border border-[#E0E0E0] rounded-xl px-4 py-4 pl-12 bg-[#FAFAFA] focus:ring-2 focus:ring-[#CFB997] outline-none font-bold text-[#5D4037] text-lg placeholder:font-normal placeholder:text-gray-400" /><MapPin size={20} className="absolute left-4 top-4.5 text-[#CFB997]" /></div></div>
                                        <div><label className="block text-xs font-bold text-[#8D6E63] uppercase tracking-wide mb-2">ÈñÄÁ•® / Ë≤ªÁî® (ÈÅ∏Â°´)</label><div className="relative"><input type="number" placeholder="0 (Ëã•‰∏çÈúÄÈñÄÁ•®ÂâáÂÖçÂ°´)" value={newActivityForm.cost} onChange={(e) => setNewActivityForm({...newActivityForm, cost: e.target.value})} className="w-full border border-[#E0E0E0] rounded-xl px-4 py-3 pl-12 bg-[#FAFAFA] focus:ring-2 focus:ring-[#CFB997] outline-none text-[#5D4037]" /><Banknote size={20} className="absolute left-4 top-3.5 text-[#CFB997]" /><span className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">ÂÖÉ</span></div></div>
                                        <div><label className="block text-xs font-bold text-[#8D6E63] uppercase tracking-wide mb-2">ÂÇôË®ª</label><textarea placeholder="‰æãÂ¶Ç: ÂåóËªäÂ§ßÂª≥ÈõÜÂêàÔºåË®òÂæóË≤∑Âè∞Èêµ‰æøÁï∂..." rows="2" value={newActivityForm.note} onChange={(e) => setNewActivityForm({...newActivityForm, note: e.target.value})} className="w-full border border-[#E0E0E0] rounded-xl px-4 py-3 bg-[#FAFAFA] focus:ring-2 focus:ring-[#CFB997] outline-none resize-none text-sm" /></div>
                                    </div>
                                </div>
                                <div className="p-6 border-t border-[#FAFAFA] bg-white sticky bottom-0 z-10"><button onClick={handleAddActivity} className="w-full bg-[#CFB997] text-white py-4 rounded-xl font-bold hover:bg-[#BCAAA4] transition-all shadow-md hover:shadow-lg flex justify-center items-center gap-2 text-lg active:scale-95"><Plus size={24} /> Âä†ÂÖ•Ë°åÁ®ã</button></div>
                            </div>
                        </div>
                    )}

                    {showTransportModal && (
                        <div className="fixed inset-0 bg-[#5D4037]/30 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 animate-in fade-in zoom-in duration-200">
                                <div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold text-[#5D4037]">ÈªûÂà∞Èªû‰∫§ÈÄö</h3><button onClick={() => setShowTransportModal(false)} className="text-gray-400 hover:text-gray-600"><X size={20} /></button></div>
                                <div className="space-y-4">
                                    <div className="grid grid-cols-3 gap-2">{TRANSPORT_OPTIONS.map(opt => <button key={opt.id} onClick={() => setTransportForm({...transportForm, type: opt.id})} className={`flex flex-col items-center justify-center p-2 rounded-xl border text-xs gap-1 transition-all active:scale-95 ${transportForm.type === opt.id ? 'bg-[#5D4037] text-white border-[#5D4037]' : 'bg-white text-[#8D6E63] border-[#EFEBE0] hover:bg-[#F5F0E6]'}`}>{opt.icon}{opt.label}</button>)}</div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="text-xs font-bold text-[#8D6E63] mb-1 flex items-center gap-1"><Timer size={12} /> È†ê‰º∞ÊôÇÈñì</label><div className="relative"><input type="text" placeholder="Â¶Ç: 30" value={transportForm.duration} onChange={(e) => setTransportForm({...transportForm, duration: e.target.value})} className="w-full border border-[#E0E0E0] rounded-lg p-2 bg-[#FAFAFA] focus:outline-none focus:border-[#CFB997]" /><span className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">ÂàÜÈêò</span></div></div>
                                        <div><label className={`text-xs font-bold text-[#8D6E63] mb-1 flex items-center gap-1 ${!getTransportOption(transportForm.type).needCost && 'opacity-30'}`}><Banknote size={12} /> Á•®ÂÉπ/ËªäË≥á</label><div className="relative"><input type="number" placeholder="0" value={transportForm.cost} onChange={(e) => setTransportForm({...transportForm, cost: e.target.value})} disabled={!getTransportOption(transportForm.type).needCost} className={`w-full border border-[#E0E0E0] rounded-lg p-2 bg-[#FAFAFA] focus:outline-none focus:border-[#CFB997] ${!getTransportOption(transportForm.type).needCost && 'bg-gray-100 cursor-not-allowed opacity-50'}`} /><span className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">ÂÖÉ</span></div></div>
                                    </div>
                                    {!getTransportOption(transportForm.type).needCost && <p className="text-xs text-[#A1887F] text-center bg-[#F5F0E6] py-1 rounded">* ÈÅ∏Êìá {getTransportOption(transportForm.type).label}ÔºåÁ≥ªÁµ±Â∞áËá™ÂãïÂøΩÁï•Ë≤ªÁî®</p>}
                                    <button onClick={saveTransport} className="w-full bg-[#CFB997] text-white py-2.5 rounded-xl font-bold hover:bg-[#BCAAA4] mt-2 active:scale-95 transition-transform">ÂÑ≤Â≠òË®≠ÂÆö</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showSettingsModal && (
                        <div className="fixed inset-0 bg-[#5D4037]/30 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md p-6 animate-in fade-in zoom-in duration-200 border border-[#EFEBE0]">
                                <div className="flex justify-between items-center mb-6 border-b border-[#FAFAFA] pb-4"><h3 className="text-xl font-bold text-[#5D4037]">ÊóÖÁ®ãË®≠ÂÆö</h3><button onClick={() => setShowSettingsModal(false)} className="text-gray-400 hover:text-gray-600 transition-colors bg-[#FAFAFA] p-2 rounded-full hover:bg-[#F5F0E6]"><X size={20} /></button></div>
                                <div className="space-y-4">
                                    <div><label className="block text-xs font-bold text-[#8D6E63] uppercase tracking-wide mb-2">ÊóÖÁ®ãÊ®ôÈ°å</label><input type="text" value={settingsForm.title} onChange={(e) => setSettingsForm({...settingsForm, title: e.target.value})} className="w-full border border-[#E0E0E0] rounded-xl px-4 py-3 bg-[#FAFAFA] focus:ring-2 focus:ring-[#CFB997] outline-none text-[#5D4037] font-bold" /></div>
                                    <div><label className="block text-xs font-bold text-[#8D6E63] uppercase tracking-wide mb-2">ÁõÆÁöÑÂú∞</label><input type="text" value={settingsForm.destination} onChange={(e) => setSettingsForm({...settingsForm, destination: e.target.value})} className="w-full border border-[#E0E0E0] rounded-xl px-4 py-3 bg-[#FAFAFA] focus:ring-2 focus:ring-[#CFB997] outline-none text-[#5D4037]" /></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-xs font-bold text-[#8D6E63] uppercase tracking-wide mb-2">Âá∫ÁôºÊó•Êúü</label><input type="date" value={settingsForm.startDate} onChange={(e) => setSettingsForm({...settingsForm, startDate: e.target.value})} className="w-full border border-[#E0E0E0] rounded-xl px-4 py-3 bg-[#FAFAFA] focus:ring-2 focus:ring-[#CFB997] outline-none text-[#5D4037]" /></div>
                                        <div><label className="block text-xs font-bold text-[#8D6E63] uppercase tracking-wide mb-2">ËøîÂÆ∂Êó•Êúü</label><input type="date" value={settingsForm.endDate} onChange={(e) => setSettingsForm({...settingsForm, endDate: e.target.value})} className="w-full border border-[#E0E0E0] rounded-xl px-4 py-3 bg-[#FAFAFA] focus:ring-2 focus:ring-[#CFB997] outline-none text-[#5D4037]" /></div>
                                    </div>
                                    <div className="bg-[#FFF8E1] p-3 rounded-lg text-xs text-[#8D6E63] leading-relaxed"><span className="font-bold block mb-1">üí° Â∞èÊèêÁ§∫Ôºö</span>‰øÆÊîπÊó•ÊúüÂæåÔºåÁ≥ªÁµ±ÊúÉËá™ÂãïÂπ´ÊÇ®Â¢ûÊ∏õÂ§©Êï∏Ôºå‰∏¶ÈáçÊñ∞Ë®àÁÆóÊØèÂ§©ÁöÑÊó•ÊúüÊ®ôÁ±§ÂñîÔºÅ</div>
                                    <button onClick={saveSettings} className="w-full bg-[#CFB997] text-white py-3 rounded-xl font-bold hover:bg-[#BCAAA4] transition-all shadow-md mt-4 active:scale-95">ÂÑ≤Â≠ò‰∏¶Êõ¥Êñ∞Ë°åÁ®ãË°®</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<TravelPlanner />);
    </script>
</body>
</html>
